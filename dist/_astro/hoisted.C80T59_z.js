const r=document.getElementById("tellraw-message"),j=document.getElementById("tellraw-color"),k=document.getElementById("tellraw-color-name"),F=j?.querySelectorAll(".tellraw__color")||[],x=document.getElementById("tellraw-weight-toggle"),B=document.getElementById("tellraw-preview"),W=document.getElementById("tellraw-command"),q=document.getElementById("tellraw-download"),G=document.getElementById("tellraw-download-all"),$=new Map;F.forEach(e=>{$.set(e.dataset.color,e.dataset.hex||"#FFFFFF")});const H=e=>$.get(e)||"#FFFFFF";let y="white",p=!1;const X=e=>{y=e,F.forEach(t=>{const n=t.dataset.color===e;t.classList.toggle("is-active",n),t.setAttribute("aria-pressed",n?"true":"false")}),k&&(k.textContent=e)};F.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.color||"white";X(t),P({applyColor:!0,applyBold:!1})})});x?.addEventListener("click",()=>{p=!p,x.classList.toggle("is-active",p),x.setAttribute("aria-pressed",p?"true":"false"),P({applyColor:!1,applyBold:!0})});const v=e=>e.filter(t=>t.text.length>0),M=e=>{if(e.length===0)return[];const t=[e[0]];for(let n=1;n<e.length;n+=1){const l=e[n],o=t[t.length-1];o.color===l.color&&o.bold===l.bold?o.text+=l.text:t.push({...l})}return t};let a=[{text:r?.value??"",color:y,bold:p}];const w=e=>e.map(t=>t.text).join(""),K=()=>{B&&(B.innerHTML="",a.forEach(e=>{const t=document.createElement("span");t.textContent=e.text,t.style.color=H(e.color),t.style.fontWeight=e.bold?"700":"400",B.appendChild(t)}))},Q=()=>{if(!W)return;const e=a.map(t=>({text:t.text,color:t.color,...t.bold?{bold:!0}:{}}));W.value=`/tellraw @p ${JSON.stringify(e)}`},L=()=>{a=v(a),a=M(a),K(),Q()},V=e=>{const t=[],n=/\n\s*\n+/g;let l=0,o;for(;(o=n.exec(e))!==null;){const s=o.index;e.slice(l,s).trim().length>0&&t.push({start:l,end:s}),l=o.index+o[0].length}return e.slice(l).trim().length>0&&t.push({start:l,end:e.length}),t},E=(e,t,n)=>{const l=[];let o=0;return e.forEach(i=>{const s=o,d=o+i.text.length;if(o=d,n<=s||t>=d)return;const h=Math.max(0,t-s),c=Math.min(i.text.length,n-s),g=i.text.slice(h,c);g&&l.push({...i,text:g})}),v(l)},O=()=>{const e=w(a),t=V(e);return t.length===0?[a]:t.map(n=>E(a,n.start,n.end))},Z=e=>{const t=w(a);if(t===e)return;let n=0;const l=Math.min(t.length,e.length);for(;n<l&&t[n]===e[n];)n+=1;let o=0;for(;o<l-n&&t[t.length-1-o]===e[e.length-1-o];)o+=1;const i=t.length-o,s=e.length-o,d=e.slice(n,s),h=E(a,0,n),c=E(a,i,t.length),g=[...h];d.length>0&&g.push({text:d,color:y,bold:p}),g.push(...c),a=M(v(g)),L()},J=async(e=a)=>{const t=document.createElement("canvas");t.width=870,t.height=130;const n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,t.width,t.height),n.fillStyle="rgba(0, 0, 0, 0.8)",n.fillRect(0,0,t.width,t.height);const o=t.width-20*2,i=t.height-20,s=32,d=e.map(u=>({...u,text:u.text.replace(/\n/g," ")}));let h=0;for(const u of d)u.text&&(n.font=`${u.bold?"700":"400"} ${s}px Minecraftia, monospace`,h+=n.measureText(u.text).width);const c=s*1.25,g=h>0?o/h:1,b=i/c,S=Math.min(g,b),f=document.createElement("canvas");f.width=Math.ceil(h||1),f.height=Math.ceil(c);const m=f.getContext("2d");if(!m)return t;m.clearRect(0,0,f.width,f.height),m.textBaseline="alphabetic";let A=0;const z=s;for(const u of d)u.text&&(m.font=`${u.bold?"700":"400"} ${s}px Minecraftia, monospace`,m.fillStyle=H(u.color),m.fillText(u.text,A,z),A+=m.measureText(u.text).width);const I=f.width*S,R=f.height*S,U=(t.width-I)/2,_=(t.height-R)/2;return n.imageSmoothingEnabled=!1,n.drawImage(f,U,_,I,R),t},N=()=>{if(!r)return null;const e=r.selectionStart??0,t=r.selectionEnd??0;return e===t?null:{start:Math.min(e,t),end:Math.max(e,t)}},P=({applyColor:e,applyBold:t})=>{const n=N();if(!n)return!1;const{start:l,end:o}=n,i=y,s=p,d=[];let h=0;return a.forEach(c=>{const g=h,b=h+c.text.length;if(h=b,o<=g||l>=b){d.push({...c});return}const S=c.text.slice(0,Math.max(0,l-g)),f=c.text.slice(Math.max(0,l-g),Math.min(c.text.length,o-g)),m=c.text.slice(Math.min(c.text.length,o-g));S&&d.push({...c,text:S}),f&&d.push({text:f,color:e?i:c.color,bold:t?s:c.bold}),m&&d.push({...c,text:m})}),a=M(v(d)),L(),!0},C=(e,t,n)=>{const l=E(a,0,e),o=E(a,t,w(a).length);if(a=M(v([...l,...n,...o])),L(),r){r.value=w(a);const i=e+w(n).length;r.setSelectionRange(i,i)}},D=()=>{if(!r)return null;const e=r.selectionStart??0,t=r.selectionEnd??0;return{start:Math.min(e,t),end:Math.max(e,t)}},Y=e=>{const t=D();if(!t||t.start===t.end)return;const n=E(a,t.start,t.end),l=w(n);e.clipboardData?.setData("text/plain",l),e.clipboardData?.setData("application/x-tellraw-segments",JSON.stringify(n)),e.preventDefault()},tt=e=>{const t=D();!t||t.start===t.end||(Y(e),C(t.start,t.end,[]))},et=e=>{const t=D();if(!t)return;const n=e.clipboardData?.getData("application/x-tellraw-segments");if(n)try{const o=JSON.parse(n);if(Array.isArray(o)){C(t.start,t.end,v(o)),e.preventDefault();return}}catch{}const l=e.clipboardData?.getData("text/plain")??"";l.length>0&&(C(t.start,t.end,[{text:l,color:y,bold:p}]),e.preventDefault())},T=()=>{if(!x)return;const e=N();if(!e)return;const{start:t,end:n}=e;let l=0,o=!1,i=!0;a.forEach(s=>{const d=l,h=l+s.text.length;l=h,!(n<=d||t>=h)&&(o=!0,s.bold||(i=!1))}),o&&(p=i,x.classList.toggle("is-active",p),x.setAttribute("aria-pressed",p?"true":"false"))};r?.addEventListener("input",()=>{const e=r.value||"";Z(e)});r?.addEventListener("copy",Y);r?.addEventListener("cut",tt);r?.addEventListener("paste",et);q?.addEventListener("click",async()=>{const e=O(),t=await J(e[0]);if(!t)return;const n=document.createElement("a");n.download="tellraw-preview.png",n.href=t.toDataURL("image/png"),n.click()});G?.addEventListener("click",async()=>{const e=O();let t=1;for(const n of e){const l=await J(n);if(!l)continue;const o=document.createElement("a");o.download=`tellraw-${t}.png`,o.href=l.toDataURL("image/png"),o.click(),t+=1}});r?.addEventListener("select",T);r?.addEventListener("keyup",T);r?.addEventListener("mouseup",T);X(y);L();
